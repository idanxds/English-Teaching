<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; padding:30px; }
        table { border-collapse: collapse; width:100%; margin-top:20px; }
        th, td { padding:10px; border:1px solid #aaa; }
        button { padding:10px 20px; }
    </style>
</head>
<body>
<h1>Admin Dashboard</h1>
<p>Viewing all registered users:</p>
<button id="btn-refresh-users">Refresh</button>
<button id="btn-export-csv">Export CSV</button>
<table>
    <thead>
        <tr><th>Email</th><th>Username</th><th>Joined</th><th>Last Active</th><th>Progress</th><th>Actions</th></tr>
    </thead>
    <tbody id="user-table"></tbody>
</table>
<br>
<button onclick="goBack()">Return to Website</button>
<button onclick="logout()">Log Out</button>
<script src="auth.js"></script>
<script>
async function loadUsers() {
    const rows = await Progress.listAllProgress();
    const table = document.getElementById('user-table');
    table.innerHTML = '';
    for(const r of rows) {
        const email = await Progress.getEmailForUserId(r.user_id);
        const username = r.profiles?.username || '-';
        const joined = r.created_at || '';
        const lastActive = r.updated_at || '';
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = email;
        const td2 = document.createElement('td'); td2.textContent = username;
        const td3 = document.createElement('td'); td3.textContent = new Date(joined).toLocaleString();
        const td4 = document.createElement('td'); td4.textContent = lastActive ? new Date(lastActive).toLocaleString() : '-';
        const td5 = document.createElement('td'); 
        const btnView = document.createElement('button'); btnView.textContent = 'View Progress';
        btnView.onclick = ()=> showProgressModal(email, username, r.data || {});
        td5.appendChild(btnView);
        const td6 = document.createElement('td');
        const resetBtn = document.createElement('button'); resetBtn.textContent = 'Reset';
        resetBtn.onclick = async ()=> {
            if(!confirm('Reset progress for ' + email + '?')) return;
            await Progress.resetUserProgress(r.user_id);
            alert('Reset');
            await loadUsers();
        };
        td6.appendChild(resetBtn);
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5); tr.appendChild(td6);
        table.appendChild(tr);
    }
}
function showProgressModal(email, username, data) {
    const w = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
    w.document.write(`<pre>${JSON.stringify({ email, username, data }, null, 2)}</pre>`);
}
function goBack(){ window.location.href = 'index.html'; }
document.getElementById('btn-export-csv').addEventListener('click', async ()=>{
    const csv = await Progress.exportAllProgressCSV();
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `progress_export_${new Date().toISOString()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
});
document.getElementById('btn-refresh-users').addEventListener('click', loadUsers);
loadUsers();
</script>
</body>
</html>
